<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 ìŠ¤íŠ¸ë ìŠ¤ëª¨ì„ íšŒê³ ë¡</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap');
        :root { --bg-color: #0f172a; --card-bg: rgba(30, 41, 59, 0.85); --text-color: #e2e8f0; --accent-color: #fbbf24; --secondary-accent: #38bdf8; --input-bg: rgba(0, 0, 0, 0.4); }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-color); font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; min-height: 100vh; display: flex; justify-content: center; }
        .snowflake { position: fixed; top: -10px; color: #fff; pointer-events: none; animation: fall linear infinite; z-index: 1; }
        @keyframes fall { to { transform: translateY(110vh); } }
        .container { width: 95%; max-width: 600px; background: var(--card-bg); backdrop-filter: blur(20px); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); z-index: 10; text-align: center; margin: 40px 10px; position: relative; }
        .img-upload-btn { background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); color: white; padding: 8px; border-radius: 8px; cursor: pointer; display: inline-block; margin-top: 10px; font-size: 0.8rem; }
        .img-preview-small { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-top: 10px; cursor: pointer; border: 1px solid var(--accent-color); }
        .profile-img-main { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); margin: 20px auto; display: block; background: #334155; }
        .profile-img-thumb { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 1px solid var(--accent-color); }
        .question-card { background: rgba(0,0,0,0.25); padding: 18px; border-radius: 15px; margin-bottom: 20px; text-align: left; border: 1px solid rgba(255,255,255,0.05); }
        .question-label { display: block; margin-bottom: 10px; font-weight: bold; color: #f1f5f9; }
        textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: var(--input-bg); color: white; font-size: 1rem; box-sizing: border-box; outline: none; min-height: 80px; resize: none; }
        .btn { background: var(--accent-color); color: #0f172a; font-weight: bold; border: none; padding: 15px; border-radius: 12px; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .grid-menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .grid-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; cursor: pointer; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 10px; cursor: pointer; background: rgba(0,0,0,0.3); color: #64748b; border: 1px solid transparent; text-align: center; }
        .tab-btn.active { background: rgba(251, 191, 36, 0.2); color: var(--accent-color); border-color: var(--accent-color); font-weight: bold; }
        .hidden { display: none; }
        .result-img { width: 100%; border-radius: 12px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="snow-container"></div>
    <div class="container">
        <div id="page-login">
            <h1>2025 íšŒê³ ë¡</h1>
            <img id="my-profile-preview" src="https://via.placeholder.com/100" class="profile-img-main">
            <label class="img-upload-btn">ğŸ“· ë‚´ ì‚¬ì§„ ì—…ë¡œë“œ (ì„ íƒ) <input type="file" accept="image/*" style="display:none;" onchange="processImage(this, 'profile')"></label>
            <input type="text" id="username" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:15px; border-radius:12px; border:none; background:var(--input-bg); color:white; font-size:1.2rem; text-align:center; box-sizing:border-box; margin-top:20px;">
            <button class="btn" onclick="checkUser()">íšŒê³  ì‹œì‘í•˜ê¸°</button>
        </div>

        <div id="page-quiz" class="hidden">
            <h2 id="display-name"></h2>
            <div id="quiz-container"></div>
            <button class="btn" onclick="addNewQuestion()">+ ìƒˆ ì§ˆë¬¸ ë§Œë“¤ê¸°</button>
            <button class="btn" onclick="saveAll()">ì €ì¥í•˜ê³  ê²°ê³¼ ë³´ê¸°</button>
        </div>

        <div id="page-dashboard" class="hidden">
            <h2>ëª¨ë‘ì˜ 2025ë…„</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div class="tab-btn active" id="tab-person" onclick="switchTab('person')">ì‚¬ëŒë³„</div>
                <div class="tab-btn" id="tab-question" onclick="switchTab('question')">ë¬¸í•­ë³„</div>
            </div>
            <div id="menu-person" class="grid-menu"></div>
            <div id="menu-question" class="grid-menu hidden"></div>
            <button class="btn" style="background:#475569; color:white;" onclick="changePage('page-quiz')">ë‚´ ë‹µë³€ ìˆ˜ì •í•˜ê¸°</button>
        </div>

        <div id="page-detail" class="hidden">
            <h3 id="detail-title"></h3>
            <div id="detail-list"></div>
            <button class="btn" onclick="changePage('page-dashboard')">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANwFDqOLJunf7_RHvn0cGG4UGD2pSs1t4",
            authDomain: "strength-2025.firebaseapp.com",
            databaseURL: "https://strength-2025-default-rtdb.firebaseio.com",
            projectId: "strength-2025",
            storageBucket: "strength-2025.firebasestorage.app",
            messagingSenderId: "235067837158",
            appId: "1:235067837158:web:a0f197b53a5c60b68c0927"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const members = ["ê²½ë¹ˆ", "ë¯¼ìš±", "ì™•ê·¼", "ì¬ê·œ", "ì •ë¯¼", "ë¬´ì² ", "ì¬í˜¸", "ê±´ìš±", "í•œìŠ¬", "êµ­ì˜", "ë³‘ì„ "];
        let currentUser = "";
        let questions = [];
        let profileImgBase64 = "";

        // ì´ë¯¸ì§€ ì••ì¶• ë° Base64 ë³€í™˜ í•¨ìˆ˜ (í•µì‹¬!)
        function processImage(input, target) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // ìµœëŒ€ í•´ìƒë„ ì œí•œ (ìš©ëŸ‰ ì¤„ì´ê¸°)
                    const max_size = 400; 
                    if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
                    else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ì••ì¶•ë¥  0.6 ì •ë„ë¡œ ì„¤ì •í•˜ì—¬ ìš©ëŸ‰ ìµœì†Œí™”
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    if(target === 'profile') {
                        profileImgBase64 = dataUrl;
                        document.getElementById('my-profile-preview').src = dataUrl;
                    } else {
                        const idx = target;
                        document.getElementById(`preview-${idx}`).src = dataUrl;
                        document.getElementById(`preview-${idx}`).classList.remove('hidden');
                        document.getElementById(`url-${idx}`).value = dataUrl;
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function checkUser() {
            const name = document.getElementById('username').value.trim();
            if(!members.includes(name)) return alert("ë©¤ë²„ ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");
            currentUser = name;
            
            // í”„ë¡œí•„ ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì €ì¥
            if(profileImgBase64) db.ref('profiles/' + currentUser).set(profileImgBase64);
            
            db.ref('settings/questions').once('value', snapshot => {
                questions = snapshot.val() || ["ì˜¬í•´ì˜ ì†Œê°"];
                renderQuiz();
                db.ref('reviews/' + currentUser).once('value', s => {
                    if(s.exists()) changePage('page-dashboard');
                    else changePage('page-quiz');
                });
            });
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = "ë¡œë”© ì¤‘...";
            db.ref('reviews/' + currentUser).once('value', snapshot => {
                const saved = snapshot.val() || {};
                container.innerHTML = "";
                questions.forEach((q, i) => {
                    const ans = saved[i] || {text: "", img: ""};
                    container.innerHTML += `
                        <div class="question-card">
                            <label class="question-label">${i+1}. ${q}</label>
                            <textarea id="ans-${i}">${ans.text}</textarea>
                            <label class="img-upload-btn">ğŸ“· ì‚¬ì§„ ì²¨ë¶€ <input type="file" accept="image/*" style="display:none;" onchange="processImage(this, ${i})"></label>
                            <input type="hidden" id="url-${i}" value="${ans.img || ''}">
                            <img src="${ans.img || ''}" id="preview-${i}" class="img-preview-small ${ans.img ? '' : 'hidden'}" onclick="window.open(this.src)">
                        </div>`;
                });
            });
        }

        function addNewQuestion() {
            const newQ = prompt("ìƒˆë¡œìš´ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if(!newQ) return;
            questions.push(newQ);
            db.ref('settings/questions').set(questions);
            renderQuiz();
        }

        function saveAll() {
            const data = {};
            questions.forEach((_, i) => {
                data[i] = {
                    text: document.getElementById(`ans-${i}`).value,
                    img: document.getElementById(`url-${i}`).value
                };
            });
            db.ref('reviews/' + currentUser).set(data);
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            initDashboard();
            changePage('page-dashboard');
        }

        function initDashboard() {
            const pMenu = document.getElementById('menu-person');
            pMenu.innerHTML = "";
            members.forEach(m => {
                db.ref('profiles/' + m).once('value', s => {
                    const img = s.val() || 'https://via.placeholder.com/50';
                    pMenu.innerHTML += `<div class="grid-item" onclick="showDetail('${m}')"><img src="${img}" class="profile-img-thumb"> ${m}</div>`;
                });
            });

            const qMenu = document.getElementById('menu-question');
            qMenu.innerHTML = "";
            questions.forEach((q, i) => {
                qMenu.innerHTML += `<div class="grid-item" style="grid-column:span 3; align-items:flex-start;" onclick="showQDetail(${i})">${i+1}. ${q}</div>`;
            });
        }

        function showDetail(name) {
            document.getElementById('detail-title').innerText = name + "ë‹˜ì˜ 2025ë…„";
            const container = document.getElementById('detail-list');
            container.innerHTML = "ë¡œë”© ì¤‘...";
            db.ref('reviews/' + name).once('value', snapshot => {
                const data = snapshot.val();
                container.innerHTML = "";
                questions.forEach((q, i) => {
                    const item = data ? data[i] : null;
                    container.innerHTML += `
                        <div class="question-card">
                            <p style="color:var(--accent-color); font-size:0.8rem;">Q. ${q}</p>
                            <p style="white-space:pre-wrap;">${item ? item.text : "ë¯¸ì‘ì„±"}</p>
                            ${item && item.img ? `<img src="${item.img}" class="result-img" onclick="window.open(this.src)">` : ""}
                        </div>`;
                });
                changePage('page-detail');
            });
        }

        function switchTab(mode) {
            document.getElementById('menu-person').classList.toggle('hidden', mode !== 'person');
            document.getElementById('menu-question').classList.toggle('hidden', mode !== 'question');
            document.getElementById('tab-person').classList.toggle('active', mode === 'person');
            document.getElementById('tab-question').classList.toggle('active', mode === 'question');
            if(mode === 'person' || mode === 'question') initDashboard();
        }

        function changePage(id) {
            ['page-login', 'page-quiz', 'page-dashboard', 'page-detail'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼
        const snow = document.getElementById('snow-container');
        for(let i=0; i<15; i++) {
            const s = document.createElement('div');
            s.className = 'snowflake'; s.innerText = 'â„';
            s.style.left = Math.random() * 100 + 'vw';
            s.style.animationDuration = (Math.random() * 3 + 4) + 's';
            snow.appendChild(s);
        }
    </script>
</body>
</html>
